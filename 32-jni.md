# JNI的运行机制

在Java代码中调用C/C++代码，并在其中实现所需功能。这种跨语言的调用，便需要借助JVM的Java Native Interface（JNI）机制。

当在Java代码中调用标记为native的、没有方法体的方法时，JVM将通过JNI，调用至对应的C函数中。

## native方法的链接

在调用native方法前，JVM需要将该native方法链接至对应的C函数上。

链接方式主要有两种。第一种是让JVM自动查找符合默认命名规则的C函数，并且链接起来。第二种链接方式则是在C代码中主动链接。

## JNI的API

JVM将所有JNI函数的函数指针聚合到一个名为JNIEnv的数据结构之中。这是一个线程私有的数据结构，JVM会为每个线程创建一个JNIEnv，并规定C代码不能将当前线程的JNIEnv共享给其它线程，否则JNI函数的正确性将无法保证。

JNI会将Java层面的基本类型以及引用类型映射为另一套可供C代码使用的数据结构。

## 局部引用与全局引用

在C代码中，我们可以访问所传入的引用类型参数，也可以通过JNI函数创建新的Java对象。

这些Java对象显然也会受到垃圾回收器的影响。因此，JVM需要一种机制，来告知垃圾回收算法，不要回收这些C代码中可能引用到的Java对象。

这种机制便是JNI的局部引用和全局引用。垃圾回收算法会将被这两种引用指向的对象标记为不可回收。
