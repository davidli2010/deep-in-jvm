# 即时编译（上）

## 分层编译模式

HotSpot虚拟机包含多个即时编译器C1、C2和Graal。

Java 7引入了分层编译的概念，综合了C1的启动性能优势和C2的峰值性能优势。

分层编译将JVM的执行状态分为了五个层次。五个层级分别是：

0. 解释执行；
1. 执行不带profiling的C1代码；
2. 执行仅带方法调用次数以及循环回边执行次数profiling的C1代码；
3. 执行带所有profiling的C1代码；
4. 执行C2代码。

在5个层次的执行状态中，1层和4层为终止状态。当一个方法被终止状态编译过后，如果编译后的代码并没有失效，那么JVM是不会再次发出该方法的编译请求的。

通常情况下，方法会首先被解释执行，然后被3层的C1编译，最后被4层的C2编译。

## 即时编译的触发

JVM是根据方法的调用次数以及循环回边的执行次数来触发即使编译的。

## OSR编译

决定一个方法是否为热点代码的因素有两个：方法的调用次数、循环回边的执行次数。即时编译便是根据这两个计数器的和来触发的。

除了以方法为单位的即时编译之外，JVM还存在着另一种以循环为单位的即时编译，叫做On-Stack-Replacement（OSR）编译。循环回边计数器便是用来触发这种类型的编译的。

OSR实际上是一种技术，它指的是在程序执行过程中，动态地替换掉Java方法栈帧，从而使得程序能够在非方法入口处进行解释执行和编译后的代码之间的切换。
