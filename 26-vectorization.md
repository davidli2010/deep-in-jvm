# 向量化

## SIMD指令

X86_64体系架构上通用寄存器的大小为64位（即8个字节），无法暂存这些超长的数据。因此，即时编译器将借助长度足够的XMM寄存器，来完成int数组与long数组的向量化读取和写入操作。

所谓的XMM寄存器，是由SSE（Streaming SIMD Extensions）指令集所引入的。它们一开始仅为128位。自从X86平台上的CPU开始支持AVX（Advanced Vector Extensions）指令集后，XMM寄存器便升级位256位，并更名位YMM寄存器。原本使用XMM寄存器的指令，现将使用YMM寄存器的低128位。

AVX512指令集更是将YMM寄存器升级至512位，并更名为ZMM寄存器。

SSE指令集以及之后的AVX指令集都涉及了一个重要的概念，那便是单指令流多数据流（Single Instruction Multiple Data，SIMD），即通过单条指令操控多组数据的计算操作。这些指令我们称之为SIMD指令。

SIMD指令将XMM寄存器（或YMM寄存器、ZMM寄存器）中的值看成多个整数或者浮点数组成的向量，并且批量进行计算。

## 使用SIMD指令的HotSpot Intrinsic

SIMD指令虽然非常高效，但是使用起来却很麻烦。这主要是因为不同的CPU所支持的SIMD指令可能不同。一般来说，越新的SIMD指令，它所支持的寄存器长度越大，功能也越强。

HotSpot虚拟机提供的是Java层面的intrinsic方法，这些intrinsic方法的语义要比单个SIMD指令复杂得多。在运行过程中，HotSpot虚拟机将根据当前体系架构来决定是否将对该intrinsic方法的调用替换为另一高效的实现。如果不，则使用原本的Java实现。

## 自动向量化

即时编译器的自动向量化将针对能够展开的计数循环，进行向量化优化。

自动向量化的条件：
1. 循环变量的增量应为1，即能够遍历整个数组。
2. 循环变量不能为long类型，否则C2无法将循环识别为计数循环。
3. 循环迭代之间最好不要有数据依赖，例如出现类似于a[i]=a[i-1]的语句。当循环展开之后，循环体内存在数据依赖，那么C2无法进行自动向量化。
4. 循环体内不要有分支跳转。
5. 不要手工进行循环展开。如果C2无法自动展开，那么它也将无法进行自动向量化。
